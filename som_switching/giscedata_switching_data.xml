<?xml version="1.0"?>
<openerp>
    <data noupdate="1">
        <record model="poweremail.templates" id="email_validacio_dades_canvi_titular">
            <field name="name">M101: Validació de dades (OV) canvi titular</field>
            <field name="object_name" model="ir.model" search="[('name', '=', 'giscedata.switching')]"/>
            <field eval="0" name="save_to_drafts"/>
            <field name="model_int_name">giscedata.switching</field>
            <field name="def_to">${object.step_ids[0].pas_id.fiscal_address_id.email}</field>
            <field eval="0" name="auto_email"/>
            <field eval="0" name="single_email"/>
            <field eval="0" name="use_sign"/>
            <field name="def_subject">Canvi de titular. Verificació de dades. Contracte ${object.cups_polissa_id.name}</field>
            <field name="template_language">mako</field>
            <field eval="0" name="send_on_create"/>
            <field name="lang">${object.cups_polissa_id.titular.lang}</field>
            <field eval="0" name="send_on_write"/>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="enforce_from_account" model="poweremail.core_accounts" search="[('name','=', 'Modificacions Contractuals')]"/>
            <field name="def_body_text"><![CDATA[
		<!doctype html>
		<html>
		<head></head>
		<body>
		<%
		nom_nou_titular =  object.step_ids[0].pas_id.fiscal_address_id.name
		%>
		%if object.polissa_ref_id.titular.lang != "es_ES":
		Benvolguts/des,<br>
		<br>
		Us informem que hem rebut correctament la sol·licitud d'un canvi de titular pel contracte número ${object.cups_polissa_id.name} amb el CUPS: ${object.cups_id.name} i del qual, fins ara, el titular és en/na  ${object.cups_polissa_id.titular.name}.<br>
		<br>
		Si es tracta d'un canvi de titularitat degut a la defunció de la persona titular actual o bé detecteu un error en el resum de dades següent, contesteu aquest correu.<br>
		<b>Si tot és correcte no és necessari que contesteu</b> i la gestió es durà a terme en un màxim de cinc dies hàbils.<br>
		És important tenir en compte que en les properes setmanes, la persona que ha estat titular fins ara, rebrà una última factura fins a la data d’activació del contracte amb la nova persona titular.<br>
		<br>
		Les dades del nou titular són:<br>
		- Nom: ${nom_nou_titular.split(',')[-1]} ${nom_nou_titular.split(',')[0]}<br/>
		- NIF, NIE o CIF: ****<br>
		- Número de compte: **** **** **** **** ****<br>
		<br>
		% if object.polissa_ref_id.soci:
		El contracte estarà associat al soci/a ${object.polissa_ref_id.soci.name.split(',')[-1]} ${object.polissa_ref_id.soci.name.split(',')[0]}.<br>
		% else:
		El contracte estarà associat al soci/a: Encara sense persona sòcia vinculada.<br/>
		% endif
		<br>
		Salutacions,<br>
		<br>
		Equip de Som Energia<br>
		modifica@somenergia.coop<br>
		<a href="www.somenergia.coop/ca">www.somenergia.coop</a><br/>
		% endif
		% if object.polissa_ref_id.titular.lang != "ca_ES" and object.polissa_ref_id.titular.lang != "es_ES":
		<br>
		----------------------------------------------------------------------------------------------------
		<br>
		% endif
		% if object.polissa_ref_id.titular.lang != "ca_ES":
		Estimados/as,<br/>
		<br/>
		Os informamos que hemos recibido correctamente la solicitud de cambio de titular del contrato número ${object.cups_polissa_id.name} con el CUPS: ${object.cups_id.name} y del cual, hasta ahora el titular es ${object.cups_polissa_id.titular.name.split(',')[-1]} ${object.cups_polissa_id.titular.name.split(',')[0]}.<br/>
		<br/>
		Si se trata de un cambio de titularidad debido a la defunción de la persona titular actual o bien detectáis un error en el resumen de datos siguiente, contestad este correo.<br/>
		<b>Si todo es correcto no es necesario que lo hagáis</b> y la gestión se llevará a cabo en un plazo máximo de cinco días hábiles.<br/>
		Es importante tener en cuenta que en las próximas semanas, la persona que ha sido titular hasta ahora, recibirá una última factura hasta la fecha de activación del contrato con la nueva persona titular.<br/>
		<br/>
		Los datos del nuevo titular son:<br/>
		- Nombre: ${nom_nou_titular.split(',')[-1]} ${nom_nou_titular.split(',')[0]}<br/>
		- NIF, NIE o CIF: ****<br/>
		- Número de cuenta: **** **** **** **** ****<br/>
		<br/>
		% if object.polissa_ref_id.soci:
		El contrato estará asociado al socio/a ${object.polissa_ref_id.soci.name.split(',')[-1]} ${object.polissa_ref_id.soci.name.split(',')[0]}.<br>
		% else:
		El contrato estará asociado al socio/a: Aún sin persona socia vinculada.<br/>
		% endif
		<br/>
		Saludos,<br/>
		<br/>
		Equipo de Som Energia<br/>
		modifica@somenergia.coop<br/>
		<a href="www.somenergia.coop/es">www.somenergia.coop</a><br/>
		% endif
		</body>
		</html>
		]]>
        </field>
	</record>
	<!-- Notificació rebuig D101-->
	<record model="poweremail.templates" id="email_atr_rebuig_d1_01">
		<field name="name">ATR D101: Rebuig dades autoproducció</field>
		<field name="object_name" model="ir.model" search="[('name', '=', 'giscedata.switching')]"/>
		<field eval="0" name="save_to_drafts"/>
		<field name="model_int_name">giscedata.switching</field>
		<field eval="0" name="use_filter"/>
		<field name="file_name">${object.codi_sollicitud}</field>
		<field name="def_to">${object.cups_polissa_id.direccio_notificacio.email}</field>
		<field eval="0" name="auto_email"/>
		<field eval="0" name="single_email"/>
		<field eval="0" name="use_sign"/>
		<field name="def_subject">Rebuig dades inst.autoproducció CUPS ${object.cups_id.name}</field>
		<field name="template_language">mako</field>
		<field eval="0" name="send_on_create"/>
		<field name="lang">${object.cups_polissa_id.titular.lang}</field>
		<field name="copyvalue">${object.codi_sollicitud}</field>
		<field eval="0" name="send_on_write"/>
		<field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
	    <field name="def_body_text"><![CDATA[
		<%!
    from mako.template import Template

    def render(text_to_render, object_):
        templ = Template(text_to_render)
        return templ.render_unicode(
            object=object_,
            format_exceptions=True
    )

    def get_partner_name(object_):
        p_obj = object_.pool.get('res.partner')
        if not object_.vat_enterprise():
            nom_titular =' ' + p_obj.separa_cognoms(object_._cr, object_._uid, object_.cups_polissa_id.titular.name)['nom']
        else:
            nom_titular = ''
        return nom_titular
%>
<%
    polissa = object.cups_polissa_id

    t_obj = object.pool.get('poweremail.templates')
    md_obj = object.pool.get('ir.model.data')
    template_id = md_obj.get_object_reference(
                        object._cr, object._uid,  'som_poweremail_common_templates', 'common_template_legal_footer'
                    )[1]

    text_legal = render(t_obj.read(
        object._cr, object._uid, [template_id], ['def_body_text'])[0]['def_body_text'],
        object
    )

%>
<!doctype html>
<html>
    <head>
        <meta charset='utf-8'>
    </head>
    % if object.cups_polissa_id.titular.lang == "ca_ES":
        ${correu_cat()}
    % else:
        ${correu_es()}
    % endif
    ${text_legal}
</html>

<%def name="correu_cat()">
    <body>
        <table width="100%" frame="below" bgcolor="#E8F1D4">
            <tr>
                <td height=2px>
                    <font size=2><strong> Contracte Som Energia nº ${polissa.name}</strong></font>
                </td>
                <td valign=top rowspan="4" align="right">
                    <img width='130' height='65' src="https://www.somenergia.coop/wp-content/uploads/2014/11/logo-somenergia.png">
                </td>
            </tr>
            <tr>
                <td height=2px>
                    <font size=1> Adreça punt subministrament: ${object.cups_id.direccio}</font>
                </td>
            </tr>
            <tr>
                <td height=2px>
                    <font size=1> Codi CUPS: ${object.cups_id.name}</font>
                </td>
            </tr>
        </table>
        <p>
            Hola${get_partner_name(object)},
        </p>
        <p>
            Ens ha arribat la notificació que no estàs d’acord amb les dades que ens ha passat l’empresa de distribució elèctrica referent a la teva instal·lació d’autoconsum associada al CUPS ${object.cups_id.name} amb direcció de subministrament ${object.cups_id.direccio}.
        </p>
        <p>
            Enviem el rebuig, amb el detall del motiu de desacord que ens has indicat a través de la teva oficina virtual, a la distribuïdora.
        </p>
        <p>
            Si es tracta d’un error en la comunicació per part de la distribuïdora ens faran arribar una nova comunicació corregida, si pel contrari es tracta d’un error a l’hora de fer el registre o de la comunicació per part de la Comunitat Autònoma cal que contacteu amb la mateixa per tal de modificar la informació i que comenci el procés novament.
        </p>
        <p>
            Malauradament, la distribuïdora no ens indica si es tracta d’una o altra casuística pel que et recomanem que contactis directament amb la distribuïdora i el departament corresponent de la teva Comunitat Autònoma per aclarir-ho.
        </p>
        <p>
            Qualsevol dubte seguim en contacte.
        </p>
	    Salutacions,<br>
        <br>
        Equip de Som Energia<br>
        <a href="mailto:modifica@somenergia.coop">modifica@somenergia.coop</a><br>
        <a href="http://www.somenergia.coop/ca">www.somenergia.coop</a>
    </body>
</%def>
<%def name="correu_es()">
    <body>
        <table width="100%" frame="below" bgcolor="#E8F1D4">
            <tr>
                <td height=2px>
                    <font size=2><strong> Contrato Som Energia nº ${polissa.name}</strong></font>
                </td>
                <td valign=top rowspan="4" align="right">
                    <img width='130' height='65' src="https://www.somenergia.coop/wp-content/uploads/2014/11/logo-somenergia.png">
                </td>
            </tr>
            <tr>
                <td height=2px>
                    <font size=1> Dirección del punto de suministro: ${object.cups_id.direccio}</font>
                </td>
            </tr>
            <tr>
                <td height=2px>
                    <font size=1> Código CUPS: ${object.cups_id.name}</font>
                </td>
            </tr>
        </table>
        <p>
            Hola${get_partner_name(object)},
	    </p>
        <p>
	        Nos ha llegado la notificación que no estás de acuerdo con los datos que nos ha pasado la empresa de distribución eléctrica referente a tu instalación de autoconsumo asociada al CUPS ${object.cups_id.name} con dirección de suministro ${object.cups_id.direccio}.
        </p>
        <p>
            Enviamos el rechazo, con el detalle del motivo de desacuerdo que nos has indicado a través de tu oficina virtual, a la distribuidora.
		</p>
        <p>
            Si se trata de un error en la comunicación por parte de la distribuidora nos harán llegar una nueva comunicación corregida, si por el contrario se trata de un error a la hora de hacer el registro o de la comunicación por parte de la Comunidad Autónoma deberás ponerte en contacto con la misma a fin de modificar la información y que comience el proceso nuevamente.
        </p>
        <p>
            Desgraciadamente, la distribuidora no nos indica si se trata de una u otra casuística por lo que te recomendamos que contactes directamente con la distribuidora y el departamento correspondiente de tu Comunidad Autónoma para aclararlo.
        </p>
        <p>
            Cualquier duda seguimos en contacto.
        </p>
        Saludos,<br>
        <br>
        Equipo de Som Energia<br>
        <a href="mailto:modifica@somenergia.coop">modifica@somenergia.coop</a><br>
        <a href="http://www.somenergia.coop/es">www.somenergia.coop</a>
    </body>
</%def>
		]]>
	</field>
    </record>
    </data>
</openerp>
