<?xml version="1.0"?>
<openerp>
    <data noupdate="1">
        <record model="res.config" id="facturacio_tasks_delete_invoices_tasks_max_procs" forcecreate="1">
            <field name="name">facturacio_tasks_delete_invoices_tasks_max_procs</field>
            <field name="value">0</field>
            <field name="description">Numero màxim de workers dedicats a eliminar factures en incidènica en paral·lel. Si s'indica '0' (per defecte), no hi ha limit.</field>
        </record>
        <record model="poweremail.templates" id="refacturacio_auto_g">
            <field name="name">Refacturacio Auto G</field>
            <field name="object_name" model="ir.model" search="[('model', '=', 'giscedata.polissa')]"/>
            <field eval="0" name="save_to_drafts"/>
            <field name="model_int_name">giscedata.polissa</field>
            <field eval="0" name="use_filter"/>
            <field name="def_to">${object.titular.address[0].email},${object.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field eval="0" name="auto_email"/>
            <field eval="0" name="use_sign"/>
            <field name="def_subject">Refacturació (contracte ${object.name})</field>
            <field name="template_language">mako</field>
	    <field name="enforce_from_account" model="poweremail.core_accounts" search="[('email_id','=', 'factura@somenergia.coop')]" />
            <field eval="0" name="send_on_create"/>
            <field name="lang">${object.titular.lang}</field>
            <field eval="0" name="send_on_write"/>
            <field name="def_body_text">
    <![CDATA[
    <!doctype html>
    <html>
    <head></head>
    <body>
    <br>
        Hola,<br>
        <br>
        T'escrivim perquè la distribuïdora ja ha corregit la incidència on ens indicaven un consum incorrecte.<br>
        <br>
    </body>
    </html>
        ]]></field>
        </record>
        <record model="poweremail.templates" id="giscedata_facturacio_comer.env_fact_via_email">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
                <![CDATA[
<%
correus = {
    'index': {
        '2.0TD': 'env_fact_via_email_20td_indexada_som',
        '3.0TD': 'env_fact_via_email_30td_indexada_som',
        '6.1TD': 'env_fact_via_email_61td_indexada_som',
    }
    'atr': {
        '2.0TD': 'env_fact_via_email_20td_periodes_som',
        '3.0TD': 'env_fact_via_email_30td_periodes_som',
        '6.1TD': 'env_fact_via_email_61td_periodes_som',
    }
}



from mako.template import Template
def render(text_to_render, object_):
    templ = Template(text_to_render)
    return templ.render_unicode(
        object=object_,
        format_exceptions=True
    )
t_obj = object.pool.get('poweremail.templates')
md_obj = object.pool.get('ir.model.data')

tipus_factura = correus[object.mode_facturacio][]

template_id = md_obj.get_object_reference(
    object._cr, object._uid,  'som_facturacio_comer', tipus_factura
)[1]
text_legal = render(t_obj.read(
    object._cr, object._uid, [template_id], ['def_body_text'])[0]['def_body_text'],
    object
)
%>
                ]]>
            </field>
        </record>
        <record model="poweremail.templates" id="env_fact_via_email_20td_periodes_som">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
            </field>
        </record>
        <record model="poweremail.templates" id="env_fact_via_email_20td_indexada_som">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
            </field>
        </record>
        <record model="poweremail.templates" id="env_fact_via_email_30td_periodes_som">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
            </field>
        </record>
        <record model="poweremail.templates" id="env_fact_via_email_30td_indexada_som">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
            </field>
        </record>
        <record model="poweremail.templates" id="env_fact_via_email_61td_periodes_som">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
            </field>
        </record>
        <record model="poweremail.templates" id="env_fact_via_email_61td_indexada_som">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
            </field>
        </record>
        <record model="poweremail.templates" id="env_fact_via_email_generica">
            <field name="name">MAIL enviar factura client normal</field>
            <field name="def_to">${object.address_invoice_id.email}, ${object.polissa_id.direccio_notificacio.email}</field>
            <field name="def_bcc">support.17062.b8d9f4469fa4d856@helpscout.net</field>
            <field name="def_subject">Factura ${object.number}</field>
            <field name="template_language">mako</field>
            <field name="lang">${object.polissa_id.titular.lang}</field>
            <field name="def_body_text">
    <![CDATA[
<%
    email_o = object.pool.get('report.backend.invoice.email')
    data = email_o.get_data(object._cr, object._uid, object.id, context=None)
    polissa_retrocedida = data['polissa']['polissa_retrocedida']
%>
<div align="right">${data['comerci']['logo']}</div>

% if data['lang'] != "es_ES":
<p><br>Benvolgut, benvolguda,</p>
<p>T'enviem
% if not polissa_retrocedida:
la
% else:
una altra
%endif
<strong>factura</strong> d'electricitat de Som Energia.</p>
% if polissa_retrocedida:
<p>Aquest mes has rebut més d'una factura a causa d'un endarreriment de les factures, o perquè la distribuïdora ens ha enviat lectures d'un període més curt. Si vols, podem canviar la data de venciment per cobrar-la quan et vagi millor.</p>
% endif
<p dir="ltr">Com sempre, carregarem l'import d'aquesta factura al teu número de compte durant els pròxims dies.</p>
<p dir="ltr"><span style="text-decoration: underline;"><strong>Resum del contingut de la factura</strong></span></p>
<ul>
<li>Número de factura: ${object.number}</li>
<li>El període facturat és del<strong id="docs-internal-guid-6536ca4e-7fff-dbd9-04a0-3e9d7d100756"> </strong>${data_inici} al ${data_final}</li>
<li>Titular del contracte: ${object.polissa_id.titular.name}</li>
<li>Número de contracte: ${object.polissa_id.name}</li>
<li>Codi CUPS: ${object.cups_id.name}</li>
<li>Adreça del punt de subministrament: ${object.cups_id.direccio}</li>
<li><strong><strong id="docs-internal-guid-531dd379-7fff-ff8b-79e9-ac3d592033e4">Import a carregar</strong>: ${object.invoice_id.amount_total}</strong>€</li>
</ul>
<p dir="ltr">Al Centre d'Ajuda t'expliquem <a href="https://ca.support.somenergia.coop/article/488-entendre-la-factura">els diferents apartats de la factura</a>.</p>
<p dir="ltr">Pots accedir a l'<a href="https://oficinavirtual.somenergia.coop/ca/login/">Oficina Virtual</a> per veure les teves factures i gestionar els contractes que tens amb la cooperativa. Si hi detectes algun error, ens ho pots comunicar responent a aquest mateix correu.&nbsp;</p>
<p dir="ltr">Aprofitem per recordar-te que els períodes horaris que t'afecten són els que descrivim al nostre web. Si tens la tarifa 2.0TD (la que tenen la majoria de contractes domèstics), continues tenint vigents els tres períodes: punta, pla i vall (descrits a l'<a href="https://www.somenergia.coop/ca/tarifes-d-electricitat/#tarifa20TD">apartat de tarifes</a> del web, i en <a href="https://ca.support.somenergia.coop/article/1003-la-tarifa-2-0td">aquest article</a> del Centre d'Ajuda). No cal que facis cas del que diuen alguns mitjans de comunicació i aplicacions sobre &ldquo;l'hora més barata del dia&rdquo;, ja que es refereixen únicament a les tarifes del mercat regulat, i Som Energia est&agrave; al mercat lliure.<strong id="docs-internal-guid-e9117f73-7fff-25dd-bcc5-080017a0d8b8"></strong></p>
% if isTariffChange(object):
<p>Com que en el període que comprèn la teva factura hi ha hagut un canvi de tarifes, una part del terme d'energia i del terme de potència est&agrave; facturada amb les tarifes d'abans del canvi, i l'altra part est&agrave; facturada amb les noves tarifes. Això fa que, a la factura, apareguin dues línies (amb els dos preus) de cadascun dels conceptes d'energia i potència.</p>
% endif
<p>Atentament,</p>
<p>Equip de Som Energia</p>
<div style="text-align: center;"><a href="https://ca.support.somenergia.coop/article/926-que-puc-fer-si-estic-en-desacord-amb-la-factura-de-la-llum"><img style="width: 189px; margin-left: auto; margin-right: auto" src="https://www.somenergia.coop/factura/dubtes_socia_som_energia.png" alt="" height="182"></a></div>
<p dir="ltr" style="text-align: center;"><a href="https://ca.support.somenergia.coop/article/926-que-puc-fer-si-estic-en-desacord-amb-la-factura-de-la-llum"><strong>Resol els teus dubtes amb la factura</strong></a></p>
% endif
% if object.partner_id.lang != "ca_ES" and object.partner_id.lang != "es_ES":
<p>----------------------------------------------------------------------------------------------------</p>
% endif
% if object.partner_id.lang != "ca_ES":
<p><br>Estimado, estimada,</p>
<p>Te enviamos
% if not polissa_retrocedida:
la
% else:
otra
%endif
<strong>factura</strong> de electricidad de Som Energia.</p>
% if polissa_retrocedida:
<p>Este mes has recibido más de una factura debido a un retraso de las facturas, o porque la distribuidora nos ha enviado lecturas de un período más corto. Si quieres, podemos cambiar la fecha de vencimiento para cobrarla cuando te vaya mejor.</p>
% endif
<p dir="ltr">Como siempre, cargaremos el importe de esta factura en tu número de cuenta durante los próximos días.</p>
<p dir="ltr"><span style="text-decoration: underline;"><strong>Resumen del contenido de la factura</strong></span></p>
<ul>
<li>Número factura: ${object.number}</li>
<li>El periodo facturado es del ${data_inici} al ${data_final}</li>
<li>Titular del contrato: ${object.polissa_id.titular.name}</li>
<li>Número de contrato: ${object.polissa_id.name}</li>
<li>Codigo CUPS: ${object.cups_id.name}</li>
<li>Dirección del punto de suministro: ${object.cups_id.direccio}</li>
<li><strong>Importe a cargar: ${object.invoice_id.amount_total}</strong>€</li>
</ul>
<p dir="ltr">En el Centro de Ayuda te explicamos <a href="https://es.support.somenergia.coop/article/489-entender-la-factura-20td">los diferentes apartados de la factura</a>.</p>
<p dir="ltr">Puedes acceder a la <a href="https://oficinavirtual.somenergia.coop/es/login/">Oficina Virtual</a> para ver tus facturas y gestionar tus contratos con la cooperativa. Si detectas algún error, puedes comunicarlo respondiendo a este mismo correo.</p>
<p dir="ltr">Aprovechamos para recordarte que los periodos horarios que te afectan son los que describimos en nuestro web. Si tienes la tarifa 2.0TD (la que tienen la mayoría de contratos domésticos), sigues teniendo vigentes los tres periodos: punta, llano y valle (descritos en el&nbsp;<a href="https://www.somenergia.coop/es/tarifas-de-electricidad/">apartado de tarifas</a> del web, y en <a href="https://es.support.somenergia.coop/article/1004-la-tarifa-2-0td">este artículo</a> del Centro de Ayuda). No hace falta que hagas caso de lo que dicen algunos medios de comunicación y aplicaciones sobre &ldquo;la hora más barata del día&rdquo;, ya que se refieren únicamente a las tarifas del mercado regulado, y Som Energia está en el mercado libre.</p>
% if isTariffChange(object):
<p>Como en el periodo que comprende tu factura ha habido un cambio de tarifas, una parte del término de energía y del término de potencia está facturada con las tarifas de antes del cambio, y la otra parte está facturada con las nuevas tarifas. Esto hace que, en la factura, aparezcan dos líneas (con los precios distintos) de cada uno de los conceptos de energía y potencia.</p>
% endif
<p>Atentamente,</p>
<p>Equipo de Som Energia</p>
<div style="text-align: center;"><a href="https://es.support.somenergia.coop/article/927-que-puedo-hacer-si-estoy-en-desacuerdo-con-la-factura-de-la-luz"><img style="width: 189px; margin-left: auto; margin-right: auto" src="https://www.somenergia.coop/factura/dubtes_socia_som_energia.png" alt="" height="182"></a></div>
<p dir="ltr" style="text-align: center;"><strong><a href="https://es.support.somenergia.coop/article/927-que-puedo-hacer-si-estoy-en-desacuerdo-con-la-factura-de-la-luz">Resuelve tus dudas con la factura</a></strong></p>
<p style="text-align: center;">&nbsp;</p>
% endif
<p>${text_legal}</p>
        ]]>
            </field>
        </record>
    </data>
</openerp>